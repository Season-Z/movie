var express=require("express"),path=require("path"),mongoose=require("mongoose"),_=require("underscore"),Movie=require("./models/movie"),User=require("./models/user"),port=process.env.PORT||3E3,app=express();mongoose.connection.openUri("mongodb://localhost/imooc");app.set("views","./views/pages");app.set("view engine","jade");var bodyParser=require("body-parser");app.use(bodyParser.urlencoded({extended:!0}));app.use(express["static"](path.join(__dirname,"public")));app.locals.moment=require("moment");
app.listen(port);console.log("imooc started on port "+port);app.get("/",function(c,d){Movie.fetch(function(a,b){a&&console.log(a);d.render("index",{title:"imooc \u9996\u9875",movies:b})})});app.post("/user/signup",function(c,d){var a=c.body.user;User.findOne({name:a.name},function(b,c){b&&console.log(b);if(c)return d.redirect("/");c=new User(a);c.comparePassword(function(b,a){b&&console.log(b);d.redirect("/admin/userlist")})})});
app.get("/admin/userlist",function(c,d){User.fetch(function(a,b){a&&console.log(a);d.render("userlist",{title:"imooc \u7528\u6237\u5217\u8868\u9875",users:b})})});app.post("/user/signin",function(c,d){var a=c.body.user,b=a.password;User.findOne({name:a.name},function(a,c){a&&console.log(a);if(!c)return d.redirect("/");console.log(c);c.comparePassword(b,function(b,a){b&&console.log(b);console.log(a);if(a)return console.log("Password is matched"),d.redirect("/");console.log("Password is not matched");return d.redirect("/admin/userlist")})})});
app.get("/movie/:id",function(c,d){Movie.findById(c.params.id,function(a,b){d.render("detail",{title:"i_movie"+b.title,movie:b})})});app.get("/admin/movie",function(c,d){d.render("admin",{title:"imooc \u540e\u53f0\u5f55\u5165\u9875",movie:{title:"",doctor:"",country:"",year:"",poster:"",flash:"",summary:"",language:""}})});app.get("/admin/update/:id",function(c,d){var a=c.params.id;a&&Movie.findById(a,function(b,a){b&&console.log(b);d.render("admin",{title:"imooc \u540e\u53f0\u66f4\u65b0\u9875",movie:a})})});
app.post("/admin/movie/new",function(c,d){var a=c.body.movie._id,b=c.body.movie,e;"undefined"!==a?Movie.findById(a,function(a,c){a&&console.log(a);e=_.extend(c,b);e.save(function(a,b){a&&console.log(a);d.redirect("/movie/"+b._id)})}):(e=new Movie({title:b.title,doctor:b.doctor,country:b.country,year:b.year,poster:b.poster,flash:b.flash,summary:b.summary,language:b.language}),e.save(function(a,b){a&&console.log(a);d.redirect("/movie/"+b._id)}))});
app.get("/admin/list",function(c,d){Movie.fetch(function(a,b){a&&console.log(a);d.render("list",{title:"imooc \u5217\u8868\u9875",movies:b})})});app["delete"]("/admin/list",function(c,d){var a=c.query.id;a&&Movie.remove({_id:a},function(a,c){a?console.log(a):d.json({success:1})})});
